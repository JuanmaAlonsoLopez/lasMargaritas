<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/logoBanner/logo.png" type="image/png">
    <title>Resumen de Compra</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../style/product.css">
    <link rel="stylesheet" href="../style/nuevo/nav-footer.css">
    <link rel="stylesheet" href="../style/carrito.css">
    <link rel="stylesheet" href="../style/ResCompra.css">

    <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>

<body>
    <header id="mainHeader">
        <div class="header-inner">
            <div class="logo" id="logo">
                <a href="../index.html">
                    <img src="../images/logoBanner/logoMargasNuevo.png" alt="Logo Las Margaritas">
                </a>
            </div>
            <nav class="main-nav" id="mainNav">
                <a href="../index.html">Inicio</a>
                <a class="activo" href="../pages/listadoProductos.html">Productos</a>
                <a href="../pages/sobreNosotros.html">Sobre nosotros</a>
                <a href="../pages/contacto.html">Contacto</a>
            </nav>
            <div class="icons" id="icons">
                <a href="#">
                    <img src="../images/logoBanner/account_circle_24dp_000000_FILL0_wght400_GRAD0_opsz24.svg" alt="Ingresar">
                </a>
                <a href="../pages/carrito.html">
                    <img src="../images/logoBanner/shopping-cart_icon-icons.com_72552.svg" alt="Carrito">
                </a>
            </div>
        </div>
    </header>
    <div class="menu-hamburguesa-btn" id="btnHamburguesa" aria-label="Abrir menú">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <nav class="menu-hamburguesa" id="menuHamburguesaResponsive">
        <a href="index.html">INICIO</a>
        <a href="./pages/categorias.html">CATEGORÍAS</a>
        <a href="./pages/listadoProductos.html">LISTADO DE PRODUCTOS</a>
        <a href="./pages/sobreNosotros.html">SOBRE NOSOTROS</a>
        <a href="./pages/contacto.html">CONTACTO</a>
    </nav>
    <div class="container">
        <div class="left-container">
            <div id="cart-products-container">
                </div>

            <div class="envio">
                <span class="envio-text">Envío</span>
                <div class="barra-envio">
                    <span>Agrega $1,500 más para conseguir envío gratis en productos de Almohadones Ortopédicos.</span>
                </div>
            </div>
            <div class="productos-relacionados">
                <span>Ver más productos de este vendedor</span>
            </div>
        </div>

        <div class="right-container">
            <div class="resumen-compra">
                <h3>Resumen de compra</h3>
                <div class="detalles">
                    <p id="product-subtotal">Producto: $0.00</p>
                    <p id="shipping-cost">Envío: $1,500.00</p>
                    <p id="total-amount">Total: $0.00</p>
                </div>
                <button id="comprar" class="continuar-compra">Continuar compra</button>
                
                <div id="wallet_container" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-grid">
            <div class="footer-right">
                <img src="../images/logoBanner/logoMargasNuevo.png" alt="Logo Las Margaritas" class="footer-logo">
                <p class="footer-desc">Fabrica de productos de confort</p>
                <a href="#" class="footer-social">
                    <div class="socialMedia">
                        <a href="https://www.instagram.com/almohadones.lasmargaritas">
                            <img src="../images/logotipo-de-instagram.png" alt="Instagram">
                        </a>
                    </div>
                </a>
            </div>
            <div class="footer-center">
                <span>Avda. Juan B. Justo 8667</span>
                <span>CABA, Argentina</span>
                <span>telefono: 11 3437-4127</span>
                <span>Email: info@lasmargaritas.online</span>
            </div>
            <div class="footer-left">
                <a href=""><span>Contacto</span></a>
                <a href=""><span>Sobre Nosotros</span></a>
                <a href=""><span>Otro</span></a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Todos los derechos reservados @ Las Margaritas 2025</p>
        </div>
    </footer>
    <script src="../js/navbar.js"></script>
    <a href="https://wa.me/5492612543607" target="_blank" class="whatsapp-float">
        <img src="../images/imageswhatsapp-icon.png" alt="WhatsApp">
    </a>
    <script src="/js/common.js"></script>

   <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURACIÓN INICIAL ---
        const cartContainer = document.getElementById('cart-products-container');
        const subtotalElem = document.getElementById('product-subtotal');
        const totalElem = document.getElementById('total-amount');
        const checkoutButton = document.getElementById('comprar');
        
        // ¡IMPORTANTE! Reemplaza esto con tu Public Key de Mercado Pago
        const publicKey = 'TU_PUBLIC_KEY';
        const mp = new MercadoPago(publicKey);

        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        // --- FUNCIONES DEL CARRITO (TU CÓDIGO ORIGINAL, SIN CAMBIOS) ---
        function renderCart() {
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p>Tu carrito de compras está vacío.</p>';
                subtotalElem.textContent = 'Producto: $0.00';
                totalElem.textContent = 'Total: $0.00';
                checkoutButton.disabled = true;
                return;
            }

            let subtotal = 0;
            cartContainer.innerHTML = cart.map(product => {
                const productTotal = product.price * product.quantity;
                subtotal += productTotal;
                return `
                    <div class="cart-product-item" data-id="${product.id}">
                        <img src="${product.image_url}" alt="${product.name}" class="cart-product-image">
                        <div class="cart-product-details">
                            <p class="cart-product-title">${product.name}</p>
                            <div class="cart-product-quantity-controls">
                                <button class="quantity-change" data-action="decrease">-</button>
                                <span class="quantity-display">${product.quantity}</span>
                                <button class="quantity-change" data-action="increase">+</button>
                            </div>
                            <p class="cart-product-price">$${productTotal.toFixed(2)}</p>
                        </div>
                        <button class="remove-item">Eliminar</button>
                    </div>
                `;
            }).join('');

            subtotalElem.textContent = `Producto: $${subtotal.toFixed(2)}`;
            const shippingCost = 1500;
            totalElem.textContent = `Total: $${(subtotal + shippingCost).toFixed(2)}`;
            checkoutButton.disabled = false;
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        cartContainer.addEventListener('click', (event) => {
            const target = event.target;
            const productItem = target.closest('.cart-product-item');
            if (!productItem) return;
            const productId = parseInt(productItem.dataset.id);
            if (target.classList.contains('quantity-change')) {
                const action = target.dataset.action;
                const productInCart = cart.find(p => p.id === productId);
                if (action === 'increase') {
                    productInCart.quantity++;
                } else if (action === 'decrease') {
                    productInCart.quantity--;
                    if (productInCart.quantity === 0) {
                        cart = cart.filter(p => p.id !== productId);
                    }
                }
            }
            if (target.classList.contains('remove-item')) {
                cart = cart.filter(p => p.id !== productId);
            }
            saveCart();
            renderCart();
        });

        // --- LÓGICA DE PAGO (MODIFICADA PARA MERCADO PAGO) ---

        /**
         * Función para renderizar el botón de Checkout Pro de Mercado Pago
         */
        function renderizarBotonDePago(preferenceId) {
            // Limpia el contenedor por si había un botón anterior
            document.getElementById('wallet_container').innerHTML = '';
            
            mp.bricks().create('wallet', 'wallet_container', {
                initialization: {
                    preferenceId: preferenceId,
                },
                customization: {
                    texts: {
                        valueProp: 'smart_option',
                    },
                },
            });
        }

        /**
         * Event listener para el botón "Continuar compra".
         * Ahora se comunica con nuestro backend para crear la preferencia de pago.
         */
        checkoutButton.addEventListener('click', async () => {
            if (cart.length === 0) {
                alert('Tu carrito está vacío.');
                return;
            }

            // Ocultamos el botón original para mostrar el de Mercado Pago
            checkoutButton.style.display = 'none';

            // Mapeamos el carrito al formato que espera nuestro backend (index.js)
            const productosParaEnviar = cart.map(product => ({
                nombre: product.name,
                cantidad: product.quantity,
                precio: product.price
            }));
            
            try {
                // Hacemos la petición a nuestro backend
                const response = await fetch('http://localhost:3000/crear-preferencia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productos: productosParaEnviar }),
                });

                const preference = await response.json();

                if (preference.id) {
                    // Si el backend nos devuelve un ID, renderizamos el botón
                    renderizarBotonDePago(preference.id);
                } else {
                    throw new Error('No se pudo obtener la preferencia de pago.');
                }

            } catch (error) {
                console.error(error);
                alert('Error al procesar el pago. Por favor, inténtalo de nuevo.');
                // Si hay un error, volvemos a mostrar el botón original
                checkoutButton.style.display = 'block';
            }
        });

        // --- INICIO DE LA EJECUCIÓN ---
        renderCart();
    });
</script>

</body>
</html>