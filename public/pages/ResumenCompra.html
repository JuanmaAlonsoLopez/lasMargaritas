<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/logoBanner/logo.png" type="image/png">
    <title>Resumen de Compra</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../style/nuevo/nav-footer.css">
    <link rel="stylesheet" href="../style/ResCompra.css">
    <style>
        #btn-pagar.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <header id="mainHeader">
        <div class="header-inner">
            <div class="logo" id="logo">
                <a href="../index.html"><img src="../images/logoBanner/logoMargasNuevo.png" alt="Logo Las Margaritas"></a>
            </div>
            <nav class="main-nav" id="mainNav">
                <a href="../index.html">Inicio</a>
                <a href="./categorias.html">Productos</a>
                <a href="./sobreNosotros.html">Sobre nosotros</a>
                <a href="./contacto.html">Contacto</a>
            </nav>
            <div class="icons" id="icons">
                <a href="#"><img src="../images/logoBanner/account_circle_24dp_000000_FILL0_wght400_GRAD0_opsz24.svg" alt="Ingresar"></a>
                <a href="./ResumenCompra.html"><img src="../images/logoBanner/shopping-cart_icon-icons.com_72552.svg" alt="Carrito"></a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="left-container">
            <h2>Mi Carrito</h2>
            <div id="cart-products-container">
                </div>
        </div>
        <div class="right-container">
            <div class="resumen-compra">
                <h3>Resumen de compra</h3>
                <div class="detalles">
                    <p id="product-subtotal">Productos: $0.00</p>
                    <p id="shipping-cost">Envío: $1,500.00</p>
                    <p id="total-amount">Total: $0.00</p>
                </div>
                <button id="btn-pagar" class="continuar-compra">Continuar compra</button>
                <div class="checkout-btn" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <footer class="footer"></footer>
    <a href="https://wa.me/5491134374127" target="_blank" class="whatsapp-float">
        <img src="../images/imageswhatsapp-icon.png" alt="WhatsApp">
    </a>

    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === Lógica para renderizar el carrito (sin cambios) ===
            const cartContainer = document.getElementById('cart-products-container');
            const subtotalElem = document.getElementById('product-subtotal');
            const totalElem = document.getElementById('total-amount');
            const shippingCost = 1500;
            const getCart = () => JSON.parse(localStorage.getItem('cart')) || [];
            
            function renderCart() {
                const cart = getCart();
                if (!cartContainer) return;

                if (cart.length === 0) {
                    cartContainer.innerHTML = '<p>Tu carrito de compras está vacío.</p>';
                    subtotalElem.textContent = 'Productos: $0.00';
                    totalElem.textContent = `Total: $${shippingCost.toFixed(2)}`;
                    document.getElementById('btn-pagar').disabled = true;
                    return;
                }

                let subtotal = 0;
                cartContainer.innerHTML = cart.map(product => {
                    const productTotal = product.price * product.quantity;
                    subtotal += productTotal;
                    return `
                        <div class="cart-product-item" data-id="${product.id}">
                            <img src="${product.image}" alt="${product.name}" class="cart-product-image">
                            <div class="cart-product-details">
                                <p class="cart-product-title">${product.name}</p>
                                <div class="cart-product-quantity-controls">
                                    <button class="quantity-change" data-action="decrease">-</button>
                                    <span class="quantity-display">${product.quantity}</span>
                                    <button class="quantity-change" data-action="increase">+</button>
                                </div>
                            </div>
                            <p class="cart-product-price">$${productTotal.toFixed(2)}</p>
                            <button class="remove-item">Eliminar</button>
                        </div>
                    `;
                }).join('');
                
                subtotalElem.textContent = `Productos: $${subtotal.toFixed(2)}`;
                totalElem.textContent = `Total: $${(subtotal + shippingCost).toFixed(2)}`;
                document.getElementById('btn-pagar').disabled = false;
            }

            function saveCart(cart) {
                localStorage.setItem('cart', JSON.stringify(cart));
            }

            cartContainer.addEventListener('click', (event) => {
                let cart = getCart();
                const target = event.target;
                const productItem = target.closest('.cart-product-item');
                if (!productItem) return;

                const productId = parseInt(productItem.dataset.id);
                const productInCart = cart.find(p => p.id === productId);

                if (target.classList.contains('quantity-change')) {
                    const action = target.dataset.action;
                    if (action === 'increase') {
                        productInCart.quantity++;
                    } else if (action === 'decrease' && productInCart.quantity > 1) {
                        productInCart.quantity--;
                    }
                } else if (target.classList.contains('remove-item')) {
                    cart = cart.filter(p => p.id !== productId);
                }
                
                saveCart(cart);
                renderCart();
            });

            // === SECCIÓN DE PAGO CON MERCADO PAGO (CORREGIDA) ===
            const checkoutButton = document.getElementById('btn-pagar');
            
            // Reemplaza con tu Public Key de producción cuando la tengas
            const publicKey = 'TEST-5a6b315b-a5f0-4396-9625-8b6142c2ba69'; 
            const mercadopago = new MercadoPago(publicKey, { locale: 'es-AR' });

            checkoutButton.addEventListener('click', async () => {
                const cart = getCart(); 
                if (cart.length === 0) {
                    alert('El carrito está vacío.');
                    return;
                }
                
                checkoutButton.disabled = true;

                try {
                    // ✅ ¡CORRECCIÓN! Se usa una ruta relativa para que funcione en producción.
                    const response = await fetch('/api/pagos/crear-preferencia', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ carrito: cart }), 
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error del servidor');
                    }

                    const preference = await response.json();

                    if (preference.id) {
                        checkoutButton.classList.add('hidden');
                        createCheckoutButton(preference.id);
                    } else {
                        throw new Error('No se recibió un ID de preferencia válido.');
                    }
                } catch (err) {
                    console.error('Error en el checkout:', err);
                    alert(`No se pudo iniciar el proceso de pago: ${err.message}`);
                    checkoutButton.disabled = false;
                }
            });

            function createCheckoutButton(preferenceId) {
                mercadopago.checkout({
                    preference: { id: preferenceId },
                    render: {
                        container: '.checkout-btn',
                        label: 'Pagar con Mercado Pago',
                    }
                });
            }
            
            renderCart();
        });
    </script>
    <script src="/js/common.js"></script>
    </body>
</html>